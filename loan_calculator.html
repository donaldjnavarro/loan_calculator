<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>

        * {
        box-sizing: border-box;
        }

        /* Create three equal columns that floats next to each other */
        .data-column {
            float: left;
            width: 20%;
            padding: 10px;
            /* height: 300px; */
        }
        .chart-column {
            float: left;
            width: 60%;
            padding: 10px;
            /* height: 300px; */
        }

        /* Clear floats after the columns */
        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        body {
            background-color: black;
            color: rosybrown;
            font-family: 'Trebuchet MS';
        }
        
        h1 {
            font-size: 35px;
        }

        input {
            padding: 7px;
            width: 70%;
            margin-top: 7px;
        }

        .container {
            display: flex;
            align-items: center;
            padding: 10% 10% 10% 10%
        }

        /* Responsive layout - makes the three columns stack on top of each other instead of next to each other */
        @media screen and (max-width: 600px) {
        .column {
            width: 100%;
        }
        }
        </style>
    <title>Loan Calculator</title>
</head>

<body>
    <div class = 'row'>
        <!-- Left rail -->
        <div class = 'data-column' id = 'leftrail'>
            <!-- Base payments -->
            <h2>Base payments</h2>

            <p>Sale Price (in thousands):</p>
            <input id="sale_price" type="number" placeholder="1" min="1" onchange="calculate()">

            <p>Interest Rate %:</p>
            <input id="interest_rate" type="number" placeholder="0" min="0" step="0.1" onchange="calculate()">

            <p>Down Payment (in thousands):</p>
            <input id="down_payment" type="number" placeholder="0" min="0" step="1" onchange="calculate()">

            <p>Monthly Payment:</p>
            <input id="monthly_payment" type="number" placeholder="1" min="1" step="1" onchange="calculate()">

            <!-- Primary results -->
            <p>Total interest paid:</p>
            <h3 id="interest_paid"></h3>
            <p>Paid in full in:</p>
            <h3 id="payments_required"></h3>
            <p>Estimated monthly payments:</p>
            <p id="ten_year_payments"></p>
            <p id="fifteen_year_payments"></p>
            <p id="twenty_year_payments"></p>
            <p id="thirty_year_payments"></p>
        </div>

        <!-- Center rail -->
        <div class = 'data-column' id = 'centerrail'>
            <!-- Optional Payment Comparisons -->
            <h2>Optional payments</h2>

            <p>Optional One-Time Payment:</p>
            <input id="optional_one_time_payment" type="number" placeholder="0" min="1" step="1" onchange="calculate()">
            
            <p>Optional Monthly Payment Increase:</p>
            <input id="optional_monthly_payment" type="number" placeholder="0" min="1" step="1" onchange="calculate()">
            
            <p>Total interest paid:</p>
            <h3 id="interest_paid_with_optional_payments"></h3>
            <p>Paid in full in:</p>
            <h3 id="payments_required_with_optional_payments"></h3>

            <p>Interest saved by optional payment:</p>
            <h3 id="money_saved_with_optional_payments"></h3>
        </div>

        <!-- Right Rail -->
        <div class = 'chart-column' id = rightrail>
            <!-- Validation -->
            <h1 id="error_message"></h1>
            <div id="interest_chart"></div>
            <div id="savings_chart"></div>
        </div>
    </div>
</body>

</html>

<body>
    <div class="container">
    <script>
        function calculate () {
            // User inputs
            const salePrice = Number(document.querySelector('#sale_price').value * 1000);
            const interestRate = Number(document.querySelector('#interest_rate').value / 100);
            const interestMonthlyRate = (interestRate / 12);
            const downPayment = Number(document.querySelector('#down_payment').value * 1000);
            const optionalOneTimePayment = Number(document.querySelector('#optional_one_time_payment').value);
            const monthlyPayment = Number((document.querySelector('#monthly_payment').value));
            const optionalMonthlyPayment = Number(document.querySelector('#optional_monthly_payment').value);
            let principal = salePrice - downPayment;
            let error = false;

            function estimateMonthlyPayment (principal, years) {
                const r = interestMonthlyRate;
                const P = principal;
                const months =  ( years * 12 );
                return (
                    (interestMonthlyRate * principal) 
                    / 
                    (1 - (1 + interestMonthlyRate) ** (0 - months))
                ).toFixed(2);
            }

            function doPayment (principal, monthlyPayment) {
                let paymentCount = 0;
                let interestPaid = 0;
                const paymentHistory = {
                    paymentNumber: [],
                    principalPayment: [],
                    interestPayment: [],
                    remainingPrincipal: [],
                };

                while (principal > 0) {
                    // payment calculations
                    paymentCount += 1;
                    const interest = principal * interestMonthlyRate;
                    interestPaid += interest;
                    const principalPayment = (monthlyPayment - interest);
                    principal = principal - principalPayment;

                    // If the user hasnt finished inputting values or puts in bad values, just wait for them to correct it
                    if ((monthlyPayment - interest) <= 0) {
                        error = true;
                        break;
                    }

                    // data for graphs
                    paymentHistory.paymentNumber.push(paymentCount);
                    paymentHistory.principalPayment.push(principalPayment);
                    paymentHistory.interestPayment.push(interest);
                    paymentHistory.remainingPrincipal.push(principal);
                }
                return { interestPaid, paymentCount, paymentHistory }
            }

            // Calculate with just base payments
            const { interestPaid, paymentCount, paymentHistory } = doPayment(principal, monthlyPayment)

            // Calculate with optional one time payment cycle
            optionalPayments = doPayment(principal - optionalOneTimePayment, monthlyPayment + optionalMonthlyPayment)

            /** Print the results */
            if (error) {
                // Validation message
                document.querySelector("#error_message")
                    .innerHTML = `${'Invalid math: Please adjust inputs'}`;

                // Blank all other messaging while in error state
                document.querySelector("#interest_paid").innerHTML = '';
                document.querySelector("#payments_required").innerHTML = '';
                document.querySelector("#interest_paid_with_optional_payments").innerHTML = '';
                document.querySelector("#payments_required_with_optional_payments").innerHTML = '';
                document.querySelector("#money_saved_with_optional_payments").innerHTML = '';
                document.querySelector("#ten_year_payments").innerHTML = '';
                document.querySelector("#fifteen_year_payments").innerHTML = '';
                document.querySelector("#twenty_year_payments").innerHTML = '';
                document.querySelector("#thirty_year_payments").innerHTML = '';

            } else {
                // Primary results
                document.querySelector("#interest_paid")
                    .innerHTML = "$" + new Intl.NumberFormat('en-US').format(interestPaid.toFixed(2).toLocaleString());

                document.querySelector("#payments_required")
                    .innerHTML = `${(paymentCount / 12).toFixed(1)} years`;
                    
                // Estimated monthly payments by payment period
                document.querySelector("#ten_year_payments")
                    .innerHTML = `10y: $${estimateMonthlyPayment(principal, 10)}/month`;
                document.querySelector("#fifteen_year_payments")
                    .innerHTML = `15y: $${estimateMonthlyPayment(principal, 15)}/month`;
                document.querySelector("#twenty_year_payments")
                    .innerHTML = `20y: $${estimateMonthlyPayment(principal, 20)}/month`;
                document.querySelector("#thirty_year_payments")
                    .innerHTML = `30y: $${estimateMonthlyPayment(principal, 30)}/month`;


                // Optional one-time payment results
                document.querySelector("#interest_paid_with_optional_payments")
                    .innerHTML = "$" + new Intl.NumberFormat('en-US').format(optionalPayments.interestPaid.toFixed(2).toLocaleString());
                document.querySelector("#payments_required_with_optional_payments")
                    .innerHTML = `${(optionalPayments.paymentCount / 12).toFixed(1)} years`;
                document.querySelector("#money_saved_with_optional_payments")
                    .innerHTML = "$" + new Intl.NumberFormat('en-US').format((interestPaid - optionalPayments.interestPaid).toFixed(2).toLocaleString());

                // Validation message
                document.querySelector("#error_message").innerHTML = `${''}`;
            }

    /** Graphs! */
    // Interest chart
    Plotly.newPlot("interest_chart",
        // Interest data
        [
            {
                name: 'basic payments',
                x: paymentHistory.paymentNumber,
                y: paymentHistory.interestPayment,
                // type: 'scatter'
                mode: 'markers'
            },
            {
                name: 'with optional payments',
                x: optionalPayments.paymentHistory.paymentNumber,
                y: optionalPayments.paymentHistory.interestPayment,
                // type: 'scatter'
                mode: 'markers'
            }
        ],
        // Layout
        {
            title:'Interest payments each month',
            xaxis: {
                title: 'Number of payments',
                showgrid: false,
                // zeroline: false
            },
            yaxis: {
                title: 'Interest paid per month',
                showline: false,
                zeroline: false
            },
            showlegend: true,
            legend: {
                // Overlay the graph to avoid forcing it to resize
                x: 1,
                xanchor: 'right',
                y: 1,
                // Transparent background
                bgcolor: 'rgba(0,0,0,0)'
            }
        }
    )
    // Savings chart
    const savingsPerMonth = [];
    for (let i = 0; i < paymentHistory.paymentNumber.length; i++ ) {
        // The last few months may be paid off, so the interest will be zero
        optionalInterestPayment = optionalPayments.paymentHistory.interestPayment[i] ? optionalPayments.paymentHistory.interestPayment[i] : 0;
        // Create a new array of savings
        savingsPerMonth.push(paymentHistory.interestPayment[i] - optionalInterestPayment);
    }
    Plotly.newPlot("savings_chart",
        // Savings data
        [
            {
                name: 'with optional payments',
                x: paymentHistory.paymentNumber,
                y: savingsPerMonth,
                // type: 'scatter'
                mode: 'markers'
            }
        ],
        // Layout
        {
            title: `Savings per month from optional payments`,
            xaxis: {
                title: '# of payments made',
                showgrid: false,
            },
            yaxis: {
                title: 'Interest saved per payment',
            },
            // No need to show legend with only 1 data set
            showlegend: false,
        }
    );
    }
    </script>
</body>
</html>