<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background-color: black;
            font-family: 'Trebuchet MS';
            color: white;
            /* content size */
            width: 400px;
            height: 450px;
            /* content centering */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 20px 100px 100px;
            /* border-radius: 50px; */
        }
        h1 {
            font-size: 35px;
        }
        input {
            padding: 7px;
            width: 70%;
            margin-top: 7px;
        }
        .container {
            display: flex;
            align-items: center;
            padding: 10% 10% 10% 10%
        }
        </style>
    <title>Loan Calculator</title>
</head>

<body>
    <div>
        <h1>Loan Calculator</h1>

        <!-- Primary fields -->
        <p>Sale Price (in thousands):
            <input id="sale_price" type="number" placeholder="1" min="1" onchange="calculate()">
        </p>

        <p>Interest Rate %:
            <input id="interest_rate" type="number" placeholder="0" min="0" step="0.1" onchange="calculate()">
        </p>

        <p>Down Payment (in thousands):
            <input id="down_payment" type="number" placeholder="0" min="0" step="1" onchange="calculate()">
        </p>

        <p>Monthly Payment:
            <input id="monthly_payment" type="number" placeholder="1" min="1" step="1" onchange="calculate()">
        </p>

        <!-- Primary results -->
        <h3 id="interest_paid"></h3>
        <h3 id="payments_required"></h3>

        <!-- Optional Payment Comparisons -->
        <p>
            <br>
            <h2>Optional One-Time Payment:</h2>
            <input id="optional_one_time_payment" type="number" placeholder="0" min="1" step="1" onchange="calculate()">
            <h2>Optional Monthly Payment Increase:</h2>
            <input id="optional_monthly_payment" type="number" placeholder="0" min="1" step="1" onchange="calculate()">
        </p>
        <h3 id="interest_paid_with_optional_payments"></h3>
        <h3 id="payments_required_with_optional_payments"></h3>
        <h3 id="money_saved_with_optional_payments"></h3>

        <!-- Validation -->
        <h1 id="error_message"></h1>
    </div>
    <div id="interest_chart"></div>
    <div id="savings_chart"></div>
</body>

</html>

<body>
    <div class="container">
    <script>
        function calculate () {
            // User inputs
            const interestRate = Number(document.querySelector('#interest_rate').value / 100);
            const salePrice = Number(document.querySelector('#sale_price').value * 1000);
            const downPayment = Number(document.querySelector('#down_payment').value * 1000);
            const optionalOneTimePayment = Number(document.querySelector('#optional_one_time_payment').value);
            const monthlyPayment = Number((document.querySelector('#monthly_payment').value));
            const optionalMonthlyPayment = Number(document.querySelector('#optional_monthly_payment').value);

            function doPayment (principal, monthlyPayment) {
                let paymentCount = 0;
                let interestPaid = 0;
                const paymentHistory = {
                    paymentNumber: [],
                    principalPayment: [],
                    interestPayment: [],
                    remainingPrincipal: [],
                };
                while (principal > 0) {
                    // payment calculations
                    paymentCount += 1;
                    const interest = principal * (interestRate / 12);
                    interestPaid += interest;
                    const principalPayment = (monthlyPayment - interest);
                    principal = principal - principalPayment;

                    // If the user hasnt finished inputting values or puts in bad values, just wait for them to correct it
                    if ((monthlyPayment - interest) <= 0) {
                        error = true;
                        break;
                    }

                    // data for graphs
                    paymentHistory.paymentNumber.push(paymentCount);
                    paymentHistory.principalPayment.push(principalPayment);
                    paymentHistory.interestPayment.push(interest);
                    paymentHistory.remainingPrincipal.push(principal);
                }
                return { interestPaid, paymentCount, paymentHistory }
            }

            let error = false;
            let principal = salePrice - downPayment;

            // Calculate with just base payments
            const { interestPaid, paymentCount, paymentHistory } = doPayment(principal, monthlyPayment)

            // Calculate with optional one time payment cycle
            optionalPayments = doPayment(principal - optionalOneTimePayment, monthlyPayment + optionalMonthlyPayment)

            // Print the results
            if (error) {
                // Validation message
                document.querySelector("#error_message")
                    .innerHTML = `${'Invalid math: Please adjust inputs'}`;

                // Blank all other messaging while in error state
                document.querySelector("#interest_paid").innerHTML = '';
                document.querySelector("#payments_required").innerHTML = '';
                document.querySelector("#interest_paid_with_optional_payments").innerHTML = '';
                document.querySelector("#payments_required_with_optional_payments").innerHTML = '';
                document.querySelector("#money_saved_with_optional_payments").innerHTML = '';

            } else {
                // Primary results
                document.querySelector("#interest_paid")
                    .innerHTML = "Total interest paid: $" + new Intl.NumberFormat('en-US').format(interestPaid.toFixed(2).toLocaleString());

                document.querySelector("#payments_required")
                    .innerHTML = `Paid in full in ${(paymentCount / 12).toFixed(1)} years`;

                // Optional one-time payment results
                document.querySelector("#interest_paid_with_optional_payments")
                    .innerHTML = "Total interest paid: $" + new Intl.NumberFormat('en-US').format(optionalPayments.interestPaid.toFixed(2).toLocaleString());
                document.querySelector("#payments_required_with_optional_payments")
                    .innerHTML = `Paid in full in ${(optionalPayments.paymentCount / 12).toFixed(1)} years`;
                document.querySelector("#money_saved_with_optional_payments")
                    .innerHTML = "Interest saved by optional payment: $" + new Intl.NumberFormat('en-US').format((interestPaid - optionalPayments.interestPaid).toFixed(2).toLocaleString());

                // Validation message
                document.querySelector("#error_message").innerHTML = `${''}`;
            }

    /** Graphs! */
    // Interest chart
    Plotly.newPlot("interest_chart",
        // Interest data
        [
            {
                name: 'basic payments',
                x: paymentHistory.paymentNumber,
                y: paymentHistory.interestPayment,
                // type: 'scatter'
                mode: 'markers'
            },
            {
                name: 'with optional payments',
                x: optionalPayments.paymentHistory.paymentNumber,
                y: optionalPayments.paymentHistory.interestPayment,
                // type: 'scatter'
                mode: 'markers'
            }
        ],
        // Layout
        {
            title:'Interest payments each month',
            xaxis: {
                title: 'Number of payments',
                showgrid: false,
                // zeroline: false
            },
            yaxis: {
                title: 'Interest paid per month',
                showline: false,
                zeroline: false
            },
            showlegend: true,
            legend: {
                // Overlay the graph to avoid forcing it to resize
                x: 1,
                xanchor: 'right',
                y: 1,
                // Transparent background
                bgcolor: 'rgba(0,0,0,0)'
            }
        }
    )
    // Savings chart
    const savingsPerMonth = [];
    for (let i = 0; i < paymentHistory.paymentNumber.length; i++ ) {
        // The last few months may be paid off, so the interest will be zero
        optionalInterestPayment = optionalPayments.paymentHistory.interestPayment[i] ? optionalPayments.paymentHistory.interestPayment[i] : 0;
        // Create a new array of savings
        savingsPerMonth.push(paymentHistory.interestPayment[i] - optionalInterestPayment);
    }
    Plotly.newPlot("savings_chart",
        // Savings data
        [
            {
                name: 'with optional payments',
                x: paymentHistory.paymentNumber,
                y: savingsPerMonth,
                // type: 'scatter'
                mode: 'markers'
            }
        ],
        // Layout
        {
            title: `Savings per month from optional payments`,
            xaxis: {
                title: '# of payments made',
                showgrid: false,
            },
            yaxis: {
                title: 'Interest saved per payment',
            },
            // No need to show legend with only 1 data set
            showlegend: false,
        }
    );
    }
    </script>
</body>
</html>